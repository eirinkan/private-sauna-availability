# プロジェクト固有ルール

## 共通ルール

### 部屋名の重複禁止
- 同じ施設内で部屋名が重複しないようにすること
- 同じ部屋の異なるプラン（午前/午後/ナイト等）は、グループ化して表示するか、プラン名で区別すること
- データ取得時に部屋名の一意性を確認すること

### 表示必須項目（部屋ごと）
各部屋には以下の情報を必ず表示すること:
1. **部屋名** - 一意であること
2. **空き時間帯** - 利用可能な時間枠
3. **人数** - 定員（例: 2名、4名）
4. **分数** - 利用時間（例: 90分、120分）
5. **価格** - 料金（例: ¥6,600〜）

### 必須リンク（施設ごと）
各施設には以下のリンクを必ず設定すること:
1. **公式ホームページ** (`hpUrl`) - 施設の公式サイト
2. **Googleマップ** (`mapUrl`) - 店舗名で検索したGoogleマップリンク
   - 形式: `https://www.google.com/maps/search/?api=1&query=店舗名+地域名`
3. **予約ページ** (`url`) - 予約サイトへの直接リンク

これにより、地域や店舗が増えても統一された形式で対応可能

### デプロイ方法
- **mainブランチへのコミット = 自動デプロイ**
- GitHubとCloud Buildが連携しており、pushすると自動的にCloud Runにデプロイされる
- デプロイ完了まで約3〜5分
- デプロイ後、`/api/refresh`でスクレイピングを再実行すると新コードが反映される
- 本番URL: `https://private-sauna-availability-526007709848.asia-northeast1.run.app`

### ナイトパックの表示形式
日をまたぐナイトパックの時間帯は、翌日の日付を**先頭**に付与する:
- 形式: `M/D HH:MM〜HH:MM`
- 例: `1/14 01:00〜08:30`
- 全施設で統一すること（GIRAFFE形式）

---

## 脈 MYAKU (spot-ly.jp) のスクレイピング

### 重要なルール

1. **カレンダーの◯✕マークは使用禁止**
   - 概要カレンダーの◯✕は日単位の空き状況のみで、具体的な時間帯がわからない
   - 必ずモーダルを開いて時間帯ボタンから取得すること

2. **ボタンのインデックスで直接指定**
   - ページ上のボタン順序は固定（0〜6）
   - PLANSのpageIndexでボタンを直接特定する

### スクレイピング手順

1. URLに日付パラメータを付与してアクセス
   ```
   https://spot-ly.jp/ja/hotels/176?checkinDatetime=YYYY-MM-DD+00%3A00%3A00&checkoutDatetime=YYYY-MM-DD+00%3A00%3A00
   ```

2. 各プランの「予約する」ボタン（`button.bg-black`）をクリックしてモーダルを開く

3. モーダル内で:
   - プラン名を取得してマッチング
   - 日付を選択
   - 時間帯ボタンの`disabled`属性で空き判定

### 空き判定方法

- **空いている時間帯**: `<button>` に `disabled` 属性がない
- **埋まっている時間帯**: `<button disabled="">`

```html
<!-- 空いている -->
<button><span>13:00</span><span>-</span><span>14:30</span></button>

<!-- 埋まっている -->
<button disabled=""><span>21:00</span><span>-</span><span>22:30</span></button>
```

### 注意事項

- **ナイトパック**: 日をまたぐため、カレンダー上の日付は翌日の予約を意味する
  - 例: カレンダーで1/14の◯は、1/13夜〜1/14朝のナイトパックが空いていることを示す
- モーダルのクリーンアップ: 次のプランを開く前に既存モーダルを閉じる

---

## GIRAFFE (reserva.be) のスクレイピング

### 重要なルール

1. **時間文字列の分割は正規表現で**
   - RESERVAのtimebox要素は`data-time`に時間を持つ（例: `09:40～11:40`）
   - `～`（全角チルダ U+FF5E）と`〜`（波ダッシュ U+301C）の両方が使われる可能性がある
   - 分割には正規表現 `/[～〜]/` を使用すること

2. **ページ再アクセス禁止**
   - 複数日のデータを取得する際、ページを再アクセス（`page.goto()`）しない
   - 同じページ内で日付をクリックして切り替えること
   - 再アクセスするとCloudflareチェックがトリガーされ、本番環境で失敗する

### スクレイピング手順

1. FlareSolverrでCloudflare Cookieを取得
2. 各部屋のURLにアクセス（1部屋1URL）
3. `input.timebox[data-vacancy="1"]`要素から空き枠を抽出
4. `data-targetgroup`（日付）と`data-time`（時間）を使用

### データ抽出コード

```javascript
// 正しい分割方法
const timeParts = time.split(/[～〜]/);
const timeRange = timeParts[0].replace(/^0/, '') + '〜' + timeParts[1].replace(/^0/, '');
```

---

## サウナヨーガン (reserva.be) のスクレイピング

### 重要なルール

1. **ページ再アクセス禁止（最重要）**
   - 7日分のデータを取得する際、2日目以降でページを再アクセスしない
   - 1回のアクセスで、日付ラベルをクリックして全日程を取得すること
   - 再アクセスすると本番環境でCloudflareに弾かれる

### スクレイピング手順

1. FlareSolverrでCloudflare Cookieを取得
2. 予約ページに1回だけアクセス
3. 各日付の`label[for="YYYY-MM-DD"]`をクリック
4. `input.timebox[data-vacancy="1"]`から空き枠を抽出
5. 次の日付をクリック（ページ再アクセスしない）

---

## サイト別メモ

### spot-ly.jp (脈)
- 認証: **ログイン不要**
- URL形式: `?checkinDatetime=YYYY-MM-DD+00%3A00%3A00&checkoutDatetime=...`
- 空き判定: ボタンの`disabled`属性で判定

### reserva.be (GIRAFFE, サウナヨーガン)
- 認証: **ログイン不要**
- Cloudflare保護あり → FlareSolverrでCookie取得必須
- 空き判定: `input.timebox[data-vacancy="1"]`
- 時間形式: `data-time="09:40～11:40"` → 全角チルダと波ダッシュの両方に対応
- **重要**: ページ再アクセス禁止（Cloudflareトリガー回避）
